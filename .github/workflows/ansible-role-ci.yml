name: Ansible Role CI

on:
  push:
  pull_request:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint_and_test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04]
        py: ["3.11", "3.12"]

    env:
      XDG_CACHE_HOME: ${{ github.workspace }}/.cache
      ANSIBLE_COLLECTIONS_PATH: ${{ github.workspace }}/.lint-collections

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.py }}
          cache: pip

      - name: Install dependencies
        working-directory: ansible_molecule
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install \
              "ansible>=9" \
              "molecule>=6" \
              "molecule-plugins[docker]>=23.5.0" \
              "ansible-lint>=24" \
              "pytest>=8" \
              "testinfra>=6,<7"
          fi

      - name: Prep caches and limits
        run: |
          mkdir -p "$XDG_CACHE_HOME" "$ANSIBLE_COLLECTIONS_PATH" || true
          ulimit -n 4096 || true
          docker --version
          ansible --version
          molecule --version

      - name: Install minimal collections for lint
        run: |
          ansible-galaxy collection install community.general community.docker -p "$ANSIBLE_COLLECTIONS_PATH"

      - name: Ansible Lint (role only)
        working-directory: ansible_molecule
        run: |
          ansible-lint roles/nginx_reverse_proxy

      - name: Molecule test (default scenario)
        working-directory: ansible_molecule/roles/nginx_reverse_proxy
        env:
          ANSIBLE_ROLES_PATH: ${{ github.workspace }}/ansible_molecule/roles
          MOLECULE_NO_LOG: "false"
        run: |
          molecule test -s default

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: molecule-logs-${{ matrix.os }}-py${{ matrix.py }}
          path: |
            /home/runner/.ansible/tmp/**/*
            ansible_molecule/roles/nginx_reverse_proxy/molecule/**/.molecule/**/*
          if-no-files-found: ignore

