# Managed by Ansible (role: nginx_reverse_proxy)
upstream lab_backend {
    server {{ nginx_backend_host }}:{{ nginx_backend_port }};
    keepalive 16;
}

map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

server {
    listen {{ http_port }} default_server;
    listen [::]:{{ http_port }} default_server;
    server_name localhost 127.0.0.1;

    access_log {{ access_log_json }} json;
    server_tokens off;

    location = {{ health_path }} {
	return 200 "OK\n";
	add_header Content-Type text/plain;
    }
    
    {% if basic_auth_user is defined and basic_auth_pass is defined %}
    auth_basic            "Restricted";
    auth_basic_user_file /etc/nginx/.htpasswd;
    {% endif %}

    location / {
	proxy_set_header Host			$host;
	proxy_set_header X-Real-IP		$remote_addr;
	proxy_set_header X-Forwarded-For	$proxy_add_x_forwarded_for;
	proxy_set_header X-Forwarded-Proto	$scheme;
	proxy_http_version 1.1;
	proxy_set_header Connection $connection_upgrade;
	proxy_set_header Upgrade    $http_upgrade;
	proxy_pass http://lab_backend;
    }
}
