---
- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600

- name: Ensure common packages are installed
  ansible.builtin.package:
    name: "{{ lab_common_packages }}"
    state: present

- name: Ensure lab_common group exists
  ansible.builtin.group:
    name: "{{ lab_common_group }}"
    state: present
  when: lab_common_create_user

- name: Ensure lab_common user exists
  ansible.builtin.user:
    name: "{{ lab_common_user }}"
    group: "{{ lab_common_group }}"
    shell: /bin/bash
    create_home: true
    state: present
  when: lab_common_create_user

- name: Deploy /etc/motd if enabled
  ansible.builtin.template:
    src: motd.j2
    dest: /etc/motd
    owner: root
    group: root
    mode: "0644"
  when: lab_common_motd_enabled

- name: Configure sudo for lab_common group when enabled
  ansible.builtin.template:
    src: sudoers_labops_group.j2
    dest: "/etc/sudoers.d/{{ lab_common_group }}"
    owner: root
    group: root
    mode: "0440"
    validate: "visudo -cf %s"
  become: true
  when: lab_common_sudo_enabled
