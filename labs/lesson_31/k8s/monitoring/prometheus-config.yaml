apiVersion: v1
kind: ConfigMap
metadata:
  name: lab30-prometheus-config
  namespace: monitoring
  labels:
    env: lab
    managed-by: kubernetes
data:
  prometheus.yml: |-
    global:
      scrape_interval: 30s
      evaluation_interval: 30s

    rule_files:
      - /etc/prometheus/alert.rules.yml

    scrape_configs:
      - job_name: "prometheus"
        static_configs:
          - targets: ["127.0.0.1:9090"]

      - job_name: "kube-state-metrics"
        static_configs:
          - targets: ["kube-state-metrics.monitoring.svc.cluster.local:8080"]

      - job_name: "lab30-web-metrics"
        metrics_path: /metrics
        static_configs:
          - targets: ["lab30-web.lab30.svc.cluster.local:8080"]
            labels:
              service: labweb
              env: lab

  alert.rules.yml: |-
    groups:
      - name: lab30-k8s
        rules:
          - alert: Lab30DeploymentNotReady
            expr: |
              kube_deployment_status_replicas_available{namespace="lab30"}
                < kube_deployment_spec_replicas{namespace="lab30"}
            for: 2m
            labels:
              severity: warning
              service: lab30
            annotations:
              summary: "Deployment in lab30 not fully available"
              description: "Some replicas are not available in namespace lab30."

          - alert: Lab30PodRestarts
            expr: increase(kube_pod_container_status_restarts_total{namespace="lab30"}[5m]) > 0
            for: 5m
            labels:
              severity: warning
              service: lab30
            annotations:
              summary: "Pod container restarts detected in lab30"
              description: "One or more containers in namespace lab30 restarted in the last 5 minutes."

          - alert: Lab31PodCrashLoopBackOff
            expr: kube_pod_container_status_waiting_reason{reason="CrashLoopBackOff",namespace="lab30"} > 0
            for: 1m
            labels:
              severity: critical
            annotations:
              summary: "Pod in CrashLoopBackOff"
              description: |
                Pod {{ $labels.pod }} (container {{ $labels.container }})
                in namespace {{ $labels.namespace }} is in CrashLoopBackOff state.
