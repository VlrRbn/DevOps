# Linux_Processes_and_Memory

---

## Обзор процессов

| Команда | Что делает | Зачем / Пример |
| --- | --- | --- |
| `ps aux` | Снимок всех процессов | Видеть PID, CPU, MEM |
| `ps aux --sort=-%cpu | head` | Топ по CPU | Найти «жруна» |
| `ps aux --sort=-%mem | head` | Топ по памяти |  |
| `ps -ef --forest` | Дерево процессов | Кто чей родитель |
| `pstree -p` | Дерево с PID | Визуализация иерархии |

**Подводные камни:** `ps` по умолчанию может различаться на BSD/Unix/Linux, `ps aux` (BSD-стиль) или `ps -ef` (SysV).

---

## Мониторинг в реальном времени

| Команда | Что делает | Зачем / Пример |
| --- | --- | --- |
| `top` | Динамический мониторинг | Общая картина |
| `htop` | Более удобный `top` | Навигация клавишами |
| `atop` | Углублённый мониторинг (CPU, диски, сеть) |  |
| `iotop` | Топ по I/O (диски) | Где узкое место |
| `glances` | Универсальный монитор | Интерактивный обзор |

**Лайфхак:** в `top` нажать `M` — сортировка по памяти,  `C` — по CPU, `1` — развернуть все ядра.

---

## Инфа по конкретному процессу

| Команда | Что делает | Пример |
| --- | --- | --- |
| `ps -p PID -o pid,ppid,stat,etime,cmd` | Статус, родитель, время | Точный снимок |
| `cat /proc/PID/status` | Детали (uid, память, флаги) | Проверка |
| `cat /proc/PID/cmdline` | Команда запуска |  |
| `lsof -p PID` | Открытые файлы/сокеты | Диагностика утечек |
| `pmap PID` | Карта памяти процесса | Смотреть RSS/heap |

---

## Управление процессами

| Задача | Команда | Пояснение |
| --- | --- | --- |
| Запустить в фоне | `sleep 300 &` | `&` = background |
| Получить PID последнего фонового | `echo $!` |  |
| Перевести в фон (suspend) | `Ctrl+Z` |  |
| Вернуть в фон | `bg %1` |  |
| Вернуть в передний план | `fg %1` |  |
| Убить мягко | `kill -SIGTERM PID` | Корректное завершение |
| Убить жёстко | `kill -9 PID` | Только если не помогло |
| Убить по имени | `pkill -f name` | Подходит для сервисов |
| Массово | `killall procname` | Осторожно |

**Подводные камни:** всегда начинать с мягкого (`SIGTERM`), потом жёсткого (`SIGKILL`).

---

## Сигналы

| Сигнал | Число | Значение |
| --- | --- | --- |
| `SIGTERM` | 15 | Вежливое завершение |
| `SIGKILL` | 9 | Безусловное убийство |
| `SIGHUP` | 1 | Перезапуск (часто для демонов) |
| `SIGINT` | 2 | Прерывание (Ctrl+C) |
| `SIGSTOP` | 19 | Приостановить |
| `SIGCONT` | 18 | Продолжить |

---

## Память и swap

| Команда | Что делает | Зачем / Пример |
| --- | --- | --- |
| `free -h` | RAM и swap | Общая картина |
| `vmstat 1 5` | CPU, память, IO, swap кажду секунду | Анализ нагрузки |
| `sar -r 1 5` | История памяти (пакет sysstat) | Тренды |
| `cat /proc/meminfo` | Подробно про память |  |
| `swapon -s` | Активные swap |  |
| `top`/`htop` | Колонки RES, VIRT, SHR | Что реально ест память |

**Лайфхак:** `RES` = реальное использование RAM, `VIRT` = виртуальное (включая mmap). Смотри на `RES`.

---

## Диагностика «кто жрёт ресурсы»

1. CPU:

```bash
ps aux --sort=-%cpu | head
```

1. MEM:

```bash
ps aux --sort=-%mem | head
```

1. I/O:

```bash
sudo iotop -ao
```

1. Открытые сокеты/файлы:

```bash
lsof -u alice | head
```

---

## nice и приоритеты

| Команда | Что делает | Пример |
| --- | --- | --- |
| `nice -n 10 cmd` | Запустить с пониженным приоритетом | Фоновые задачи |
| `renice -n 5 -p PID` | Изменить приоритет | Для уже работающих |
| `top` → `r` | Изменить приоритет внутри `top` |  |

**Диапазон:** `-20` (максимальный приоритет) … `19` (минимальный).

**Подводные камни:** менять чужие процессы можно только root.

---

## Контроль ресурсов (ulimit, cgroups)

| Приём | Команда | Пояснение |
| --- | --- | --- |
| Ограничить ресурсы сессии | `ulimit -a` | Показать все лимиты |
| Установить лимит памяти | `ulimit -v 500000` | Виртуальная память (KB) |
| Системный уровень | `cat /etc/security/limits.conf` | Лимиты для пользователей |
| cgroups v2 | `systemd-run --user -p MemoryMax=500M cmd` | Современный способ |

---

## Практикум

1. **Запустить процесс и поймать его PID**:

```bash
sleep 300 &echo $!   # PIDps -p $! -o pid,ppid,stat,etime,cmd
```

1. **Приостановить и возобновить**:

```bash
kill -STOP $PIDsleep 2
kill -CONT $PID
```

1. **Убить по имени**:

```bash
pkill -f sleep
```

1. **Посмотреть память по процессу**:

```bash
pmap $PID | tail -n 1
```

1. **Создать стресс по памяти** (пакет `stress-ng`):

```bash
stress-ng --vm 2 --vm-bytes 512M --timeout 10s
```

---

## Security Checklist

- Проверять процессы от **неожиданных пользователей**: `ps aux | grep nobody`
- Следить за SUID-бинарниками: `find / -xdev -perm -4000 -type f -ls 2>/dev/null`
- Логи `oom-killer` (если память кончилась):
    
    ```bash
    dmesg | grep -i kill
    ```
    
- Для аудита: `auditd` с правилами на `execve` (запуск процессов).

---

## Быстрые блоки

```bash
# Топ-10 по CPU
ps aux --sort=-%cpu | head

# Топ-10 по MEM
ps aux --sort=-%mem | head

# Дерево процессов (альтернатива pstree)
ps -ef --forest | head -40

# Убить все процессы user
sudo pkill -u username

# Показать открытые файлы процесса
lsof -p PID | less

# История нагрузки по памяти (через sar)
sar -r 1 10
```