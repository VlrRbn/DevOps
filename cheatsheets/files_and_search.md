# files_and_search

---

## Навигация по каталогам

| Команда | Что делает | Зачем / Пример |
| --- | --- | --- |
| `pwd` | Показать текущий путь | Проверить контекст перед `rm`/`mv` |
| `cd DIR` / `cd` / `cd ~` | Перейти (домой) | `cd /etc/nginx`, `cd ~/Downloads` |
| `cd ..` / `cd -` | Вверх / назад | Быстрое перемещение по дереву |
| `pushd DIR` / `popd` | Стек каталогов | Обход нескольких путей по кругу |

**Подводные камни:** пути с пробелами — кавычки: `cd "/path with spaces"`.

---

## Листинг и метаданные

| Команда | Что делает | Зачем / Пример |
| --- | --- | --- |
| `ls -la` | Подробный листинг, скрытые файлы | Смотреть права/владельца/дату |
| `ls -lh`/ `-lah` | Человекочитаемые размеры | Сравнивать размеры файлов |
| `stat FILE` | Полные метаданные файла | Проверить inode, времена atime/mtime/ctime |
| `file FILE` | Тип содержимого | Понять двоичный/текстовый/архив |
| `tree -L 2` | Дерево каталогов (пакет `tree`) | Быстро увидеть структуру |

**Лайфхак:** `ls -l --time-style=long-iso` для стабильного формата дат.

---

## Создание/копирование/перемещение/удаление

| Команда | Что делает | Зачем / Пример |
| --- | --- | --- |
| `touch file` | Пустой файл / обновить mtime | Заглушки, триггеры |
| `mkdir -p a/b/c` | Вложенные каталоги | Без ошибок, если уже есть |
| `rmdir dir` | Удалить **пустой** каталог | Чистка пустых директорий |
| `cp -a SRC DST` | Копия c атрибутами | Бэкап/миграция без потерь прав |
| `mv SRC DST` | Переместить/переименовать | Рефактор структуры |
| `rm -I -- path` | Удаление всего с одним подтверждением | Без рутины `-i` и безопаснее |
| `rm -i file` | Удаление с подтверждением | Защита от случайностей |
| `rm -r dir` | Рекурсивное удаление | Чистка деревьев |
| `rm -rf dir` | Жёсткое удаление без вопросов | **Опасно** — использовать осознанно |
| `find TARGET -mindepth 1 -delete` | Чистка содержимого каталога | Не «копнёт» выше нужного |

**Подводные камни:** имена, начинающиеся с `-` → `rm -- "-filename"`; всегда добавляй `--` перед списком путей.

---

## Права и владельцы (важно!)

| Команда | Что делает | Зачем / Пример |
| --- | --- | --- |
| `chmod 640 file` | Права (octal) | Быстро задать режим |
| `chmod u=rw,g=r,o- file` | Символьный синтаксис | Точечно добавить/убрать флаги |
| `chmod 2775 dir` | SGID на каталоге | Новые файлы унаследуют группу |
| `chmod +t /shared` | Sticky bit | В общих каталогах удаляет только владелец |
| `chown user:group path [-R]` | Смена владельца/группы | После копий/распаковок |
| `getfacl` / `setfacl` | ACL | Тонкая выдача доступа |
| `umask` | Базовые права по умолчанию | Контроль «с рождения» |

**Подводные камни:** ACL может «перекрывать» обычные права — проверять `getfacl` при странном поведении.

---

## Просмотр содержимого файлов

| Команда | Что делает | Зачем / Пример |
| --- | --- | --- |
| `less -S file` | Постраничный просмотр, `-S` не переносить строки | Идеально для логов/конфигов |
| `/pattern` / `n` в `less` | Поиск вперёд / следующее совпадение | Быстро находить строки |
| `head -n 50 file` | Первые N строк | Посмотреть заголовок/формат |
| `tail -n 50 file` | Последние N строк | Хвост логов |
| `tail -f file` | Следить за изменениями | Лайв-мониторинг |
| `zless file.gz` | Просмотр сжатого | Исторические логи |

---

## Поиск файлов (имена, свойства)

| Команда | Что делает | Зачем / Пример |
| --- | --- | --- |
| `find DIR -name "*.log"` | По имени | Найти логи |
| `find DIR -type f -size +100M` | По размеру | Охота на «жрунов» |
| `find DIR -mtime -1` | По времени модификации | Что менялось за сутки |
| `find DIR -maxdepth 2 -mindepth 2 -type d` | Глубина поиска | Точная выборка |
| `find DIR -newermt "today" ! -newermt "tomorrow"` | По времени (календарные сутки) | «За сегодня» точно |
| `find DIR \( -perm -4000 -o -perm -2000 \) -type f` | SUID/SGID | Аудит безопасности |
| `find . -type f -print0 | xargs -0 …` | Безопасные пайпы | Имена с пробелами/ |
| `locate filename` | Быстрый индексированный поиск | В 100× быстрее `find` (нужен `plocate`) |
| `-exec … {} +` | Пакетный exec | Быстрее, чем `{} \;` |

**Лайфхак:** `LC_ALL=C` ускоряет сортировки/парсинг, `-xdev` ограничит ФС.

---

## Поиск текста (содержимое)

| Команда | Что делает | Зачем / Пример |
| --- | --- | --- |
| `grep -RInI --exclude-dir=<DIR> 'PATTERN' .` | Рекурсивный поиск (без бинарников) | Универсальный шаблон |
| `grep -E 'foo|bar'` / `-i` / `-v` | Расширенные регэкспы / регистр / инверсия | Гибкая фильтрация |
| `zgrep PATTERN file.gz` | Поиск в сжатых логах | История без распаковки |
| `rg -n PATTERN` |  `ripgrep` | Ускоренный поиск |

**Подводные камни:** `grep -R` **следует** по symlink-директориям, `-r` — нет. В огромных деревьях лучше предфильтровать по `--include`/`--exclude`. Безопасно передавать паттерн: `grep -F "literal*text"` (без регэкспа).

---

## Где команда

| Команда | Что делает | Зачем / Пример |
| --- | --- | --- |
| `type -a ls` | Показать, как шелл найдёт команду | Встроенная/alias/путь |
| `command -v ls` | Путь до команды | В скриптах надёжнее `which` |
| `whereis cmd` | Бинарь+man+исходники | Быстрый обзор |

---

## Архивы и синхронизация

| Команда | Что делает | Зачем / Пример |
| --- | --- | --- |
| `cp -a SRC DST` | Копия с сохранением атрибутов | Миграции/бэкапы |
| `tar -czvf backup.tar.gz DIR/` | Архив + сжатие | Релиз/бэкап |
| `tar -xvf backup.tar.gz -C /restore` | Распаковать | В нужное место |
| `rsync -aHAX --delete --dry-run SRC/ DST/` | Синк «как есть», пробный | Проверить, что удалится |
| `rsync -aHAX --delete SRC/ DST/` | Синк по-настоящему | После dry-run |
| `rsync -aHAX -e ssh SRC/ user@host:DST/` | По сети (SSH) | Удобный транспорт |

**Подводные камни:** `-A`/`-X` переносят ACL/xattr — нужна поддержка на обеих ФС. Тщательно смотреть на завершающий слэш у `SRC` (`SRC/` = содержимое каталога).

---

## Размеры и место

| Команда | Что делает | Зачем / Пример |
| --- | --- | --- |
| `du -sh * | sort -h` | Размеры директорий | Найти, что занимает место |
| `du -xh --max-depth=1 . | sort -h` | «Кто съедает место» рядом | Быстрый обзор |
| `find . -type f -printf '%s %p\n' | sort -nr | head -10 | numfmt --to=iec` | Топ-10 больших файлов | Красивые числа |
| `df -hT` | Свободное место по ФС | Контроль по разделам |

---

## Паттерны оболочки (globbing/brace/quoting)

| Приём | Что делает | Пример |
| --- | --- | --- |
| Globbing | Шаблоны имён | `ls *.log`, `rm data-2025-??-*.csv` |
| Brace expansion | Генерация списков | `touch file{1..5}.txt` |
| Кавычки | Защита пробелов/символов | `mv "weird name.txt" safe.txt` |

---

## Практикум

1. **Аудит SUID/SGID**

```bash
find / -xdev \( -perm -4000 -o -perm -2000 \) -type f -printf '%M %m %u:%g %p\n' 2>/dev/null | sort > suid_audit.txt
```

2. **Ошибки nginx «за сегодня» (access.log)**

```bash
zgrep -h "$(date '+%d/%b/%Y')" /var/log/nginx/access.log* 2>/dev/null \
| awk '$9 ~ /^[45][0-9][0-9]$/ {codes[$9]++; errs++} {total++}
       END {
         printf "Total: %d\nErrors (4xx+5xx): %d (%.2f%%)\n", total, errs, (total?100*errs/total:0);
         for (c in codes) printf "  %s: %d\n", c, codes[c];
       }'
```

3. **Бэкап $HOME на внешний диск (dry-run → реальность)**

```bash
RSRC="$HOME/";
RDST="/media/$USER/Backup/home/"
rsync -aHAX --delete --dry-run "$RSRC" "$RDST"
rsync -aHAX --delete "$RSRC" "$RDST"
```

---

## Security Checklist

- Перед `rm -r` → посмотреть **`pwd`** и сделать `ls` цели.
- Использовать кавычки и `-` перед именами, начинающимися с : `rm -- "-file"`.
- Массовые операции после `find` → `print0 | xargs -0` или `exec … +`.
- Делать «сухой прогон»: `echo rsync …` / `rsync -n` / ограничить область `grep`/`find`.
- Даты и резервные копии: `tar czf backup-$(date +%F).tgz DIR`.
- Для «жёстких» действий (`--delete`) — бэкап перед запуском.

---

## Быстрые блоки

```bash
# 1) Рекурсивно найти файлы по имени (без учёта регистра)
find . -type f -iname '*config*'

# 2) Найти строку во всех текстовых файлах, исключая .git
grep -RInI --exclude-dir=.git 'Listen 80' .

# 3) Сравнить два каталога (списками)
diff -ruN dirA/ dirB/

# 4) Скопировать с прогрессом и сохранить атрибуты
rsync -aP source/ dest/

# 5) Топ-10 самых больших файлов (читабельно)
find . -type f -printf '%s %p\n' | sort -nr | head -10 | numfmt --to=iec
```