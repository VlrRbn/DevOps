# Linux_Users_and_Permissions

---

## Базовая диагностика

| Команда | Что делает | Зачем / Пример |
| --- | --- | --- |
| `id` | UID/GID, группы | Понять, кем видит система |
| `who` / `w` | Активные сессии | Кто залогинен/что делает |
| `logname` | Имя пользователя сессии | Когда `sudo` путает контекст |
| `getent passwd USER` | Запись из базы NSS | Универсально (локально/LDAP/AD) |
| `getent group GROUP` | Инфа о группе | Проверить членство |
| `groups USER` | Список групп | Быстрое членство |

---

## Пользователи: создание, изменение, удаление

> На Debian/Ubuntu есть удобная обёртка adduser (интерактивная). Низкоуровневые команды: useradd/usermod/userdel.
> 

| Задача | Команда | Пояснение |
| --- | --- | --- |
| Создать пользователя с домашним и shell | `sudo useradd -m -s /bin/bash alice` | `-m` создать `$HOME`, `-s` задать шелл |
| Установить пароль | `sudo passwd alice` | Интерактивный ввод |
| Сменить основной (primary) GID | `sudo usermod -g developers alice` | Основная группа |
| Добавить во вспомогательные группы | `sudo usermod -aG sudo,docker alice` | `-aG` = добавить, не затирая |
| Переименовать пользователя | `sudo usermod -l newname oldname` | Осторожно с `$HOME` |
| Переместить/переименовать домашний | `sudo usermod -d /home/newname -m newname` | `-m` перенесёт файлы |
| Заблокировать/разблокировать | `sudo usermod -L alice` / `-U` | Блокирует вход по паролю |
| Установить дату истечения | `sudo usermod -e 2025-12-31 alice` | Автоматическое отключение |
| Удалить пользователя | `sudo userdel alice` | Аккаунт без домашнего останется |
| Удалить с домашним | `sudo userdel -r alice` | Удалит `$HOME` и почту |

**Подводные камни:**

- **НЕ** путать `-G` и `-aG` в `usermod`: без `-a` ты *перезапишешь* список групп.

- При переименовании `$HOME` использовать `-d NEW -m` для переноса.

- В доменных окружениях проверять `getent`, а не `/etc/passwd` напрямую.

---

## Группы: создание и управление

| Задача | Команда | Пояснение |
| --- | --- | --- |
| Создать группу | `sudo groupadd developers` |  |
| Переименовать группу | `sudo groupmod -n devs developers` |  |
| Удалить группу | `sudo groupdel developers` |  |
| Добавить пользователя в группу | `sudo usermod -aG developers alice` | Типичный кейс |
| Сменить пароль группы | `sudo gpasswd developers` | Редко используется |
| Войти во вновь выданную группу без relogin | `newgrp developers` | Обновляет эффективные группы в текущем шелле |

**Лайфхак:** на Debian/Ubuntu есть `adduser alice developers` как удобная альтернатива `usermod -aG`.

---

## Права доступа: rwx и спецбиты

Формат `-rwxr-x---` / `750` (владелец / группа / остальные).

| Приём | Команда | Пояснение |
| --- | --- | --- |
| Числовые права | `chmod 640 file` | `6`=rw-, `4`=r--, `0`=--- |
| Символьные | `chmod u+rw,g+r,o- file` | Точно добавить/убрать флаги |
| Сменить владельца | `sudo chown user:group path -R` | Рекурсивно |
| Только группа | `sudo chgrp group path` | Если владелец не меняется |
| Маска по умолчанию | `umask` / `umask 027` | Влияет на новые файлы/папки |

| chmod | Символы | Что значит |
| --- | --- | --- |
| 600 | `rw-------` | только владелец читает/пишет (секретные файлы: SSH ключи `id_rsa`) |
| 644 | `rw-r--r--` | владелец пишет, остальные читают (типично для конфигов, документов) |
| 666 | `rw-rw-rw-` | все читают и пишут (редко, небезопасно: world-writable) |
| 700 | `rwx------` | полный доступ только владельцу (скрипты, приватные каталоги) |
| 755 | `rwxr-xr-x` | владелец пишет, все могут читать и запускать (типично для бинарей и скриптов) |
| 775 | `rwxrwxr-x` | владелец и группа пишут, остальные только читают/запускают (shared dirs) |
| 777 | `rwxrwxrwx` | полный доступ для всех (опасно, иногда нужно для tmp-директорий) |

| Цифра | Символ | Значение |
| --- | --- | --- |
| 7 | rwx | все права |
| 6 | rw- | read + write |
| 5 | r-x | read + execute |
| 4 | r-- | только read |
| 3 | -wx | write + execute |
| 2 | -w- | только write |
| 1 | --x | только execute |
| 0 | --- | нет прав |

### Спецбиты

| Бит | Число | Где применим | Эффект |
| --- | --- | --- | --- |
| setuid (s) | `4xxx` | Файлы | Процесс получает EUID владельца |
| setgid (s) | `2xxx` | Файлы/директории | У файлов — EGID владельца; у директорий — новые файлы наследуют **группу** |
| sticky (t) | `1xxx` | Директории | Удалять внутри может только владелец файла или root (пример: `/tmp`) |

**Примеры:**

```bash
# SGID на общей директории: всё внутри наследует одну группу 
sudo chgrp devs /srv/shared
sudo chmod 2775 /srv/shared
# Sticky на «песочнице»
sudo chmod 1777 /srv/scratch
```

**Подводные камни:** `chmod 2775` → первая цифра `2` = SGID; `1` = sticky; `4` = setuid.

| Цифра | Биты | Где видно в `ls -l` | Значение |
| --- | --- | --- | --- |
| 1 | sticky | `t` в конце (drwxrwxrwt) | Только владелец может удалять файлы в директории (`/tmp`) |
| 2 | setgid | `s` в правах группы | Новые файлы наследуют группу директории (общие каталоги) |
| 4 | setuid | `s` в правах владельца | Программа запускается с правами владельца (пример: `/usr/bin/passwd`) |
| Комбо | Складываются (например 6) | 4+2 = setuid+setgid |  |

---

## ACL (расширенные разрешения)

Когда обычных `rwx` не хватает.

| Команда | Что делает | Пример |
| --- | --- | --- |
| `getfacl path` | Показать ACL | Диагностика |
| `setfacl -m u:alice:rw file` | Разрешение для пользователя | Выдать доступ точечно |
| `setfacl -m g:devs:rwx dir` | Разрешение для группы | Совместная папка |
| `setfacl -d -m g:devs:rwx dir` | **Default ACL** для новых файлов | Наследование прав |
| `setfacl -x u:alice file` | Удалить правило | Чистка ACL |

**Подводные камни:** Иногда ACL «переезжает» поверх обычных прав. Если поведение неожиданное — смотреть `getfacl`.

---

## Sudo, su, sudoers

| Приём | Команда | Пояснение |
| --- | --- | --- |
| Проверить права sudo | `sudo -l` | Что разрешено пользователю |
| Безопасное редактирование | `sudo visudo` | Правка `/etc/sudoers` с проверкой синтаксиса |
| Добавить группу в sudoers | файл в `/etc/sudoers.d/90-admins` | Разделяй правила по файлам |
| Сменить пользователя | `su - USER` | Полная сессия как USER |
| Выполнить одну команду от имени | `sudo -u USER cmd` | Без полноценного входа |

**Мини-пример sudoers (в файле `/etc/sudoers.d/90-admins`):**

```
%admins ALL=(ALL) NOPASSWD: /usr/bin/systemctl *, /usr/bin/journalctl *
```

> Даёт членам группы admins запускать systemctl/journalctl без пароля. Использовать аккуратно.
> 

**Подводные камни:** Никогда не редактировать `/etc/sudoers` напрямую без `visudo`. Проверять, что `Defaults env_reset` не ломает переменные окружения нужные скрипту.

---

## Пароли, срок действия и блокировки

| Задача | Команда | Пояснение |
| --- | --- | --- |
| Установить/сменить пароль | `sudo passwd USER` |  |
| Массовая установка паролей | `sudo chpasswd` | `echo 'user:pass' | sudo chpasswd` |
| Политики паролей | `/etc/login.defs`, PAM (например, `pam_pwquality`) | Минимальная длина, сложность |
| Срок действия | `sudo chage -l USER` | Посмотреть |
| Изменить срок/минимум/предупреждение | `sudo chage -E 2025-12-31 -M 90 -m 1 -W 7 USER` |  |
| Заблокировать/разблокировать вход по паролю | `sudo passwd -l USER` / `-u` | Ставит `!` в `/etc/shadow` |

**ПАМ-плагины (кратко):** `pam_faillock` (блокировка после X неудач), `pam_pwquality` (сложность пароля). Настройки в `/etc/pam.d/*` — меняй только если понимаешь последствия.

---

## Системные пользователи и /etc/skel

| Тема | Ключевые моменты |
| --- | --- |
| Системные пользователи | UID обычно < 1000 (на Debian/Ubuntu), без входа в систему (`/usr/sbin/nologin`) |
| Создать «сервисного» пользователя | `sudo useradd -r -s /usr/sbin/nologin -M -d /nonexistent svc_foo` |
| Шаблоны файлов | `/etc/skel` — содержимое копируется в `$HOME` при `useradd -m` |
| Диапазоны UID/GID | `grep -E '^(UID|GID)_MIN|_MAX' /etc/login.defs` |

---

## Поиск по правам / владельцам (аудит)

| Задача | Команда |
| --- | --- |
| Найти SUID файлы | `sudo find / -xdev -perm -4000 -type f -printf '%M %u %p\n' 2>/dev/null` |
| Найти файлы, принадлежащие удалённому пользователю | `sudo find / -xdev -uid 12345 -ls 2>/dev/null` |
| Найти миро-доступные файлы | `find . -type f -perm -o=r -printf '%m %p\n'` |
| Несовпадение владельца/группы в проекте | `find /srv/app -not -user app -o -not -group app -ls` |

---

## Capabilities (вместо setuid)

| Команда | Что делает | Пример |
| --- | --- | --- |
| `getcap /path/to/bin` | Показать capabilities |  |
| `sudo setcap cap_net_bind_service=+ep /usr/local/bin/myapp` | Разрешить слушать <1024 порт без root | Безопаснее, чем setuid |

---

## Атрибуты файловой системы (расширенные, ext4)

| Команда | Что делает | Пример |
| --- | --- | --- |
| `lsattr file` | Показать атрибуты |  |
| `chattr +i file` | «Нерушимый» файл | Защита от случайного удаления |
| `chattr +a dir` | Разрешены только добавления | Логи/журналы |

**Подводные камни:** атрибут `+i` может ломать пакеты/скрипты — использовать точечно и помннить, что для изменения атрибутов нужен root.

---

## Практикум

1. **Общая директория с SGID + ACL:**

```bash
sudo groupadd devs
sudo mkdir -p /srv/shared
sudo chgrp devs /srv/shared
sudo chmod 2775 /srv/shared                 
# SGID, группа наследуетсяsudo setfacl -d -m g:devs:rwx /srv/shared   
# default ACL для новых файлов
sudo usermod -aG devs alice
sudo usermod -aG devs bob
```

Проверка: `touch /srv/shared/test; ls -l /srv/shared/test` → группа `devs` и права унаследованы.

1. **Выдать пользователю право рестартовать сервис без пароля:**

```
# /etc/sudoers.d/90-restart-nginx
alice ALL=(root) NOPASSWD:/bin/systemctl restart nginx
```

Проверка: `sudo -l -U alice` и `sudo systemctl restart nginx` под `alice`.

1. **Блок учётной записи по требованию:**

```bash
sudo usermod -L alice     # или sudo passwd -l alicesudo chage -E 2025-09-30 alice
```

1. **Найти все SUID-бинарники и проверить целостность:**

```bash
sudo find / -xdev -perm -4000 -type f -print0 2>/dev/null | xargs -0 ls -l
```

---

## Security Checklist

- Минимизировать SUID, использовать `setcap` где возможно.
- `umask 027` для админов/серверов по умолчанию (меньше world-доступа).
- Всегда проверять, **в каких группах ты находишься** (`id`, `groups`) перед админскими действиями.
- ACL — мощно, но **прозрачность падает**. Документировать, где они применяются.
- `sudoers` — только через `visudo` и с разбивкой на файлы в `/etc/sudoers.d/`.
- Для сервисных учёток — shell = `/usr/sbin/nologin`, `M`, `r`, отдельные каталоги/права.

---

## Быстрые блоки

```bash
# 1) Добавить пользователя, выдать sudo
sudo useradd -m -s /bin/bash alice
echo 'alice:StrongP@ss!' | sudo chpasswd
sudo usermod -aG sudo alice

# 2) Общая папка для команды devssudo groupadd -f devs
sudo mkdir -p /srv/shared && sudo chgrp devs /srv/shared
sudo chmod 2775 /srv/shared
sudo setfacl -d -m g:devs:rwx /srv/shared

# 3) Запретить вход паролем (только ключи/sudo)
sudo usermod -L alice
# или:sudo passwd -l alice

# 4) Проверить, где «дырявые» права
find /srv/app -type f -perm -o=w -printf '%m %p\n'
```